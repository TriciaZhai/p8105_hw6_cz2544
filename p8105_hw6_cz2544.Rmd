---
title: "p8105_hw6_cz2544"
author: "Chunxiao Zhai"
date: "11/16/2018"
output: github_document
---

```{r setup, include=FALSE}
library(p8105.datasets)
library(tidyverse)
library(ggridges)
library(viridis)
library(patchwork)
library(pander)
panderOptions('round', 3)
panderOptions('keep.trailing.zeros', TRUE)
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "95%"
)
theme_set(theme_bw() + theme(legend.position = "bottom"))
```

##Problem 1

The Washington Post has gathered data on homicides in 50 large U.S. cities and made the data available through a GitHub repository here.

Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. 

Modifiy  victim_race to have categories white and non-white, with white as the reference category. Be sure that victim_age is numeric.

```{r load_homicide}
homi_data = read.csv("homicide-data.csv") %>% 
  mutate(city_state = str_c(city, state, sep = ", "),
         solve = if_else(disposition == "Closed by arrest", 1, 0)) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>% 
  mutate(victim_race_bin = if_else(victim_race == "White", "white", "non-white"),
         victim_race_bin = relevel(as.factor(victim_race_bin), ref = "white"),
         victim_age = as.numeric(victim_age)) 
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Save the output of glm as an R object; apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.

```{r glm_logi_Balti}
fit_logi = homi_data %>%
  filter(city == "Baltimore") %>% 
  glm(solve ~ victim_age + victim_race_bin + victim_sex, data = ., family = binomial()) 

OR_data = fit_logi %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         OR_ci_low = exp(pull(broom::confint_tidy(fit_logi), 1)), 
         OR_ci_high = exp(pull(broom::confint_tidy(fit_logi), 2))) %>% 
  select(term, log_OR = estimate, OR, OR_ci_low, OR_ci_high, p.value)

```

With all other variables fixed, the estimate of adjusted odds ratio for solving homicides comparing non-white victims to white victims is `r pull(OR_data, OR)[3]`, the 95% confidence interval is (`r pull(OR_data, OR_ci_low)[3]`, `r pull(OR_data, OR_ci_high)[3]`).

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of  purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r orci_eachcity, warning=FALSE}
homi_data_orci = homi_data %>% 
  group_by(city_state) %>% 
  nest(victim_age, victim_race_bin, victim_sex, solve ) %>% 
  mutate(models_glm = map(data, ~glm(solve ~ victim_age + victim_race_bin + victim_sex, data = ., family = binomial())),
         models = map(models_glm, broom::tidy),
         ci = map(models_glm, broom::confint_tidy)) %>% 
  select(-data, -models_glm) %>% 
  unnest() %>% 
  filter(term  == "victim_race_binnon-white") %>% 
  mutate(OR = exp(estimate),
         OR_ci_low = exp(conf.low), 
         OR_ci_high = exp(conf.high)) %>% 
  select(city_state, starts_with("OR"))
```

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

```{r plot_orci}
homi_data_orci_plot = 
  homi_data_orci %>% 
  arrange(OR) %>% 
  mutate(city_state = fct_inorder(city_state)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
    geom_point(size = 2) +
    geom_errorbar(aes(ymin = OR_ci_low, ymax = OR_ci_high), width = 0.2) +
    labs(
    title = "Adjusted OR for solving homicides non-white vs white for 47 large U.S. cities",
    y = "OR estimates",
    caption = "Data from the Washington Post"
  )  +
  theme(axis.text.x = element_text(angle =  -60,size = 6, vjust = -1.4 ))

homi_data_orci_plot
```

Comment: Among the 47 cities, only 3 have ORs slightly over 1 (`r pull(tail(homi_data_orci%>%arrange(OR),3),1)`), probably due to large error. In all other 44 cities, ORs are less than 1, indicating cases of non-white victims are less likely to solve. But in some cities with low OR, the errors are big and the 95% confidence interval contains 1, like Richmand, Washingto and New York. There are `r sum(homi_data_orci$OR_ci_high >= 1)` cities with OR confidence interval contain 1, and `r sum(homi_data_orci$OR_ci_high < 1)` cities with OR confidence interval do not contain 1. Top 5 cities with lowest ORs are `r pull(head(homi_data_orci%>%arrange(OR),5),1)`.


##Problem 2

In this probelm, you will analyze data gathered to understand the effects of several variables on a child’s birthweight. This dataset, available here, consists of roughly 4000 children and includes the following variables:

babysex: baby’s sex (male = 1, female = 2)
bhead: baby’s head circumference at birth (centimeters)
blength: baby’s length at birth (centimeteres)
bwt: baby’s birth weight (grams)
delwt: mother’s weight at delivery (pounds)
fincome: family monthly income (in hundreds, rounded)
frace: father’s race (1= White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other, 9 = Unknown)
gaweeks: gestational age in weeks
malform: presence of malformations that could affect weight (0 = absent, 1 = present)
menarche: mother’s age at menarche (years)
mheigth: mother’s height (inches)
momage: mother’s age at delivery (years)
mrace: mother’s race (1= White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other)
parity: number of live births prior to this pregnancy
pnumlbw: previous number of low birth weight babies
pnumgsa: number of prior small for gestational age babies
ppbmi: mother’s pre-pregnancy BMI
ppwt: mother’s pre-pregnancy weight (pounds)
smoken: average number of cigarettes smoked per day during pregnancy
wtgain: mother’s weight gain during pregnancy (pounds)
Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).

Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add_predictions and  add_residuals in making this plot.

Compare your model to two others:

One using length at birth and gestational age as predictors (main effects only)
One using head circumference, length, sex, and all interactions (including the three-way interaction) between these
Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.

Note that although we expect your model to be reasonable, model building itself is not a main idea of the course and we don’t necessarily expect your model to be “optimal”.

